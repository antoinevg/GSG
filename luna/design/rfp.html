<p>&lt;!DOCTYPE html&gt;
<html lang="en">
<head>
<link rel="stylesheet" href="./rfp.css">
<style>
body { padding: 100px; }
img { max-width: 1024; }
</style>
<meta charset="utf-8">
<meta name="description" content="Luna Initial Design Specification">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>rfp.html</title>
</head></p>

<body>

<h1 id="facedancer:implementinitialdesignspecificationrfp68https:github.comgreatscottgadgetslunaissues68"><a href="https://github.com/greatscottgadgets/luna/issues/68">FaceDancer: Implement Initial Design Specification / RFP #68</a></h1>

<h2 id="maintask">Main Task</h2>

<p>Create an initial design document describing a FaceDancer backend for LUNA.</p>

<p>This should:</p>

<ul>
<li>[ ] Include plans for the core backend.</li>
<li>[ ] Accommodate future FPGA acceleration, where possible.</li>
<li>[ ] Accommodate fancy USBProxy enhancements.</li>
</ul>

<hr />

<h2 id="terms">Terms</h2>

<ul>
<li>Should = goal</li>
<li>Shall = requirement</li>
<li>Will = facts or declaration of purpose</li>
</ul>

<hr />

<h2 id="1introduction">1 Introduction</h2>

<p>The Facedancer software is a host-side Python module for the control of simple hardware devices that act as &quot;remote-controlled&quot; USB controllers.</p>

<h3 id="1.1dataflow">1.1 Data flow</h3>

<p>Adding support to Facedancer for a new remote-controlled USB device (&quot;the device&quot;) requires the implementation of a number of major components on both the controlling host (&quot;the host&quot;) and the device being controlled.</p>

<p>This proposal will cover the requirements for the development of a Facedancer backend for the <a href="https://greatscottgadgets.com/luna/">Great Scott Gadgets Luna</a>.</p>

<p>Understanding the relationships between the major components of Facedancer can best be visualized in terms of the data flow between them:</p>

<figure>
<img src="dataflow/luna.svg" alt="Diagram: Data Flow" />
<figcaption>Diagram: Data Flow</figcaption>
</figure>

<p>The host side can be broken down into the following major components:</p>

<ol>
<li>The <em>Luna Facedancer Backend</em>: <code>facedancer.git:/facedancer/backends/moondancer.py</code></li>
<li>The <em>Luna host-side Python Library</em>: <code>luna.git:/host/</code></li>
<li>The <em>Luna host-side CLI</em>: : <code>luna.git:/host/</code></li>
<li>The <em>Host-side Command Serialization and Transport Library</em>: <code>libgreat.git:/host/pygreat/</code></li>
</ol>

<p>The device side consists of the major components:</p>

<ol>
<li>The <em>Device-side Transport Library</em>: <code>libgreat-rs.git:/firmware/drivers/</code></li>
<li>The <em>Device-side Command Serialization Library</em>: <code>libgreat-rs.git:/firmware/drivers/</code></li>
<li>The <em>Luna Device API</em>: <code>luna.git:/luna/firmware/soc/classes/</code></li>
<li>The <em>Luna SoC Firmware</em>: <code>luna.git:/luna/firmware/soc/</code></li>
<li>The <em>Luna SoC Peripheral Drivers</em>: <code>libgreat-rs.git:/firmware/platform/soc/drivers/</code></li>
<li>The <em>Luna SoC Gateware</em>: <code>luna.git:/luna/gateware/</code></li>
<li>The <em>Luna Physical Hardware</em>: <code>luna.git:/hardware/</code></li>
</ol>

<hr />

<h2 id="2hostsideimplementation">2 Host Side Implementation</h2>

<p>There is an existing host side implementation in Python which targets the <a href="https://greatscottgadgets.com/greatfet/">Greatt Scott Gadgets GreatFET</a>. We should be able to re-use much of the code with only minor modification and re-organization of the existing codebase.</p>

<p>This section exists primarily to serve as a reference to how this code is currently organized.</p>

<!--
![Diagram: Facedancer](facedancer/top_facedancer.svg)
TODO split into individual diagrams for each section
-->

<p>The primary use-case for Facedancer is writing small Python scripts to automate the behaviour of Facedancer &quot;Applets&quot;. Facedancer Applets are Python classes that encapsulate the behaviour of a given USB Device to be emulated.</p>

<p>For example:</p>

<figure>
<img src="facedancer/facedancer_git.examples_rubber_ducky.svg" alt="Diagram: Facedancer Rubber Ducky Example" />
<figcaption>Diagram: Facedancer Rubber Ducky Example</figcaption>
</figure>

<p>Currently, there are two Applets available:</p>

<ul>
<li><a href="https://github.com/greatscottgadgets/Facedancer/blob/master/facedancer/devices/ftdi.py"><code>FTDIDevice</code></a> - Emulated FTDI USB Serial device.</li>
<li><a href="https://github.com/greatscottgadgets/Facedancer/blob/master/facedancer/devices/keyboard.py"><code>USBKeyboardDevice</code></a> - Simple USB Keyboard device.</li>
</ul>

<p>There are also a number of legacy Applets available that we will talk about more in <a href="">Section 5.5</a>.</p>

<p>This user-facing scripting environment is abstracted away from any given Facedancer hardware allowing support to be extended for new devices.</p>

<p>The entry-point for adding new device support to Facedancer is via the implementation of a Luna Facedancer Backend.</p>

<h3 id="2.1lunafacedancerbackend">2.1 Luna Facedancer Backend</h3>

<p>A Facedancer host backend (&quot;the facedancer backend) is responsible for servicing the API surface exposed to Facedancer Applets. (&quot;the Facedancer Applet API&quot;)</p>

<figure>
<img src="facedancer/facedancer_git.backends_moondancer.svg" alt="Diagram: Luna Facedancer Backend" />
<figcaption>Diagram: Luna Facedancer Backend</figcaption>
</figure>

<p>As such, it is primarily responsible for enacting the following functionality on the device being controlled by Facedancer:</p>

<ul>
<li>Initializing the USB device, configuration, interface and endpoint descriptors of the emulated device.</li>
<li>Reading data from the emulated device's endpoints.</li>
<li>Writing data to the emulated device's endpoints.</li>
</ul>

<h3 id="2.2lunahost-sidepythonlibrary">2.2 Luna host-side Python Library</h3>

<p>Great Scott Gadgets device commands are organized into a simple class/verb schema to define a transport-independent RPC protocol called the Great Communications Protocol (&quot;GCP&quot;) for communication with a host-connected device.</p>

<p>Amongst other capabilities, this enables the automatic generation and population of a host-side Python API object that reflects the commands implemented in the firmware of the device.</p>

<figure>
<img src="facedancer/libgreat_git.pygreat.svg" alt="Diagram: Luna host-side Python Library" />
<figcaption>Diagram: Luna host-side Python Library</figcaption>
</figure>

<h3 id="2.3commandserializationandtransportlibrary">2.3 Command Serialization and Transport Library</h3>

<p>Luna uses USB as the transport for GCP messages.</p>

<p>The host-side implementation can be found in the <a href="https://github.com/greatscottgadgets/libgreat/tree/master/host/pygreat"><code>pygreat</code></a> library.</p>

<h3 id="2.4maintasks:">2.4 Main Tasks:</h3>

<ul>
<li>[ ] Derive a new Luna Facedancer Backend from <a href="https://github.com/greatscottgadgets/Facedancer/blob/master/facedancer/backends/greatdancer.py">facedancer.git:/facedancer/backends/greatdancer.py</a></li>
<li>[ ] Derive a new Luna host-side Python Library from <a href="https://github.com/greatscottgadgets/greatfet/tree/master/host/greatfet/">greatfet.git:/ host/greatfet/</a></li>
<li>[ ] Integrate the Command Serialization and Transport Library from: <a href="https://github.com/greatscottgadgets/libgreat/blob/master/host/pygreat/comms_backends/usb.py">libgreat.git:/host/pygreat/comms_backends/usb.py</a></li>
</ul>

<hr />

<h2 id="3devicesidefirmwareimplementation">3 Device Side Firmware Implementation</h2>

<p>The primary function of the Device Firmware is to implement the functionality defined by the GCP messages between Facedancer and the device.</p>

<p>Additional functionality includes logging, error handling, reset control, device heartbear and SoC firmware updates.</p>

<figure>
<img src="structure/luna_git.firmware.svg" alt="Diagram: Firmware Structure" />
<figcaption>Diagram: Firmware Structure</figcaption>
</figure>

<p>The device firmware shall be implemented in Rust following established community guidelines for Embedded Rust development.</p>

<h3 id="3.1lunasocfirmware">3.1 Luna SoC Firmware</h3>

<p>The following functionality should be supported:</p>

<ul>
<li>Error handler</li>
<li>Logger</li>
<li>Reset control</li>
<li>Task scheduler and interrupt handler</li>
<li>Device heartbeat</li>
<li>SoC firmware update</li>
</ul>

<p>The Firmware should have memory access to:</p>

<ul>
<li>SoC SRAM</li>
<li>SPI Flash</li>
<li>HyperRAM</li>
</ul>

<h4 id="referenceimplementation">Reference Implementation</h4>

<p><a href="https://github.com/greatscottgadgets/greatfet/tree/master/firmware/greatfet_usb/">greatfet.git:/firmware/greatfet_usb/</a></p>

<figure>
<img src="greatfet/top_greatfet.svg" alt="Diagram: GreatFET Firmware Call Graph" />
<figcaption>Diagram: GreatFET Firmware Call Graph</figcaption>
</figure>

<h3 id="3.2lunasocperipheraldrivers">3.2 Luna SoC Peripheral Drivers</h3>

<p>Drivers should be implemented for the following SoC peripherals:</p>

<ul>
<li><code>luna.gateware.soc.GpioPeripheral</code></li>
<li><code>lambdasoc.periph.timer.TimerPeripheral</code></li>
<li><code>amaranth_stdio.serial.AsyncSerial</code></li>
<li><code>luna.gateware.usb2.USBDeviceController</code></li>
<li><code>luna.gateware.interface.flash.ECP5ConfigurationFlashInterface</code></li>
</ul>

<p>Peripheral drivers will be organized across three crates:</p>

<ul>
<li><code>lunasoc-pac</code> - A peripheral register access API generated by <code>svd2rust</code></li>
<li><code>amaranth-hal</code> - Concrete implementations of the device-independent <code>embedded-hal</code> traits for the peripherals.</li>
<li><code>lunasoc-hal</code> - Re-exports of <code>libgreat-hal</code> and any peripherals that don't belong in amaranth-soc.</li>
</ul>

<blockquote>
<p>Note: The embedded-hal drivers can live in <code>lunasoc-hal</code> during development but with the understanding that this code can potentially run on any SoC built using the <code>amaranth-soc</code> and <code>lambdasoc</code> libraries. As such, it would be beneficial to both GSG and the Amaranth community if it could find a forever home upstream.</p>
</blockquote>

<h4 id="referenceimplementation">Reference Implementation</h4>

<p><a href="https://github.com/greatscottgadgets/libgreat/tree/master/firmware/platform/lpc43xx">libgreat.git:/firmware/platform/lpc43xx/</a></p>

<h3 id="3.3commandserializationandtransportlibrary">3.3 Command Serialization and Transport Library</h3>

<p>The USB serialization and Transport libary is responsible for marshalling &quot;Great Communication Protocol&quot; commands from the host to the device.</p>

<p>Command execution takes the form of a host request containing the command class, verb and parameters followed by a device response containing one or more return parameters.</p>

<p>The library implementation shall follow the format and conventions established by the <a href="https://greatfet.readthedocs.io/en/latest/greatfet_classes.html">&quot;GreatFET Communications Protocol&quot;</a>.</p>

<p>We can break library implementation down into three main components:</p>

<h4 id="3.3.1.usbtransport">3.3.1. USB Transport</h4>

<p>The USB transport is responsible for reading host requests and sending device responses using the USBDeviceController peripheral driver.</p>

<h4 id="3.3.2.commandserialization">3.3.2. Command Serialization</h4>

<p>Command Serialization is responsible for:</p>

<ul>
<li>Deserializing commands read from the USB transport to a Rust representation.</li>
<li>Serializing command responses in Rust representation to USB transport responses.</li>
</ul>

<h4 id="3.3.3.commanddispatch">3.3.3. Command Dispatch</h4>

<p>Command dispatch is responsible for:</p>

<ul>
<li>Dispatching GCP commands in Rust representation to their corresponding Rust implementations.</li>
<li>Scheduling the command response for serialization and transport.</li>
</ul>

<h4 id="referenceimplementation">Reference Implementation</h4>

<p><a href="https://github.com/greatscottgadgets/libgreat/tree/master/firmware/drivers/comms/">libgreat.git:/firmware/drivers/comms/</a></p>

<h3 id="3.4lunadeviceapi">3.4 Luna Device API</h3>

<h4 id="thefollowinggcpclassesshallbeimplementedforthelunadeviceapi:">The following GCP classes shall be implemented for the Luna device API:</h4>

<ul>
<li><code>0x0 core</code>

<ul>
<li>core device identification functionality</li>
</ul></li>
<li><code>0x1 firmware</code>

<ul>
<li>verbs for working with/updating device firmware</li>
</ul></li>
<li><code>0x10 debug</code>

<ul>
<li>debug utilities</li>
</ul></li>
<li><code>0x11 selftest</code>

<ul>
<li>utilities for self-testing libgreat-based boards</li>
</ul></li>
<li><code>0x10A leds</code>

<ul>
<li>control over a given board’s LEDs</li>
</ul></li>
<li><code>0x120 moondancer</code> (new class, implementing the verbs from <code>0x104 greatdancer</code>)

<ul>
<li>remote control over Luna's USB ports in device mode, for e.g. FaceDancer</li>
</ul></li>
<li><code>0x10F usbproxy</code>

<ul>
<li>Firmware functionality supporting USBProxy</li>
</ul></li>
</ul>

<h4 id="additionalclassesofinterestare:">Additional classes of interest are:</h4>

<ul>
<li><code>0x101 spi_flash</code>

<ul>
<li>verbs for programming SPI flashes</li>
</ul></li>
<li><code>0x103 gpio</code>

<ul>
<li>control the GreatFET’s idle/”heartbeat” LED</li>
</ul></li>
<li><code>0x105 usbhost</code> <em>(is this supported ? see <a href="">Open Questions</a>)</em>

<ul>
<li>remote control over Luna's USB ports in host mode, for e.g. FaceDancer</li>
</ul></li>
<li><code>0x107 glitchkit_usb</code>

<ul>
<li>control over functionality intended to help with timing USB fault injection</li>
</ul></li>
<li><code>0x113 usb_analysis</code>

<ul>
<li>functionality for USB analysis e.g. with Rhododendron</li>
</ul></li>
</ul>

<h4 id="thefollowinggcpverbsshallbeimplementedforeachclass:">The following GCP verbs shall be implemented for each class:</h4>

<h4 id="0x0core-libgreat.git:firmwareclassescore.chttps:github.comgreatscottgadgetslibgreatblobmasterfirmwareclassescore.c"><code>0x0 core</code> - <a href="https://github.com/greatscottgadgets/libgreat/blob/master/firmware/classes/core.c"><code>libgreat.git:/firmware/classes/core.c</code></a></h4>

<p>Core device identification functionality:</p>

<ul>
<li><code>0x0, core_verb_read_board_id() -&gt; board_id: u32</code></li>
<li><code>0x1, core_verb_read_version_string() -&gt; [u8]</code></li>
<li><code>0x2, core_verb_read_part_id() -&gt; [u8; 8]</code></li>
<li><code>0x3, core_verb_read_serial_number() -&gt; [u8; 16]</code></li>
<li><code>0x20, core_verb_request_reset()</code> (deprecated from core)</li>
</ul>

<p>Internal introspection commands:</p>

<ul>
<li><code>0x4, verb_get_available_classes</code></li>
<li><code>0x5, verb_get_verb_name</code></li>
<li><code>0x6, verb_get_verb_descriptor</code></li>
<li><code>0x7, verb_get_available_verbs</code></li>
<li><code>0x8, verb_get_class_name</code></li>
<li><code>0x9, verb_get_class_docs</code></li>
</ul>

<h4 id="0x1firmware-libgreat.git:firmwareclassesfirmware.chttps:github.comgreatscottgadgetslibgreatblobmasterfirmwareclassesfirmware.c"><code>0x1 firmware</code> - <a href="https://github.com/greatscottgadgets/libgreat/blob/master/firmware/classes/firmware.c"><code>libgreat.git:/firmware/classes/firmware.c</code></a></h4>

<p>Verbs for working with/updating device firmware:</p>

<ul>
<li><code>0x0, firmware_verb_initialize() -&gt; (page_size: u32, total_size: u32)</code></li>
<li><code>0x1, firmware_verb_full_erase()</code></li>
<li><code>0x2, firmware_verb_erase_page(address: u32)</code></li>
<li><code>0x3, firmware_verb_write_page(address: u32, data: Page)</code></li>
<li><code>0x4, firmware_verb_read_page(address: u32) -&gt; data: Page</code></li>
</ul>

<h4 id="0x10debug-greatfet.git:firmwaregreatfet_usbclassesdebug.chttps:github.comgreatscottgadgetsgreatfettreemasterfirmwaregreatfet_usbclassesdebug.c"><code>0x10 debug</code> - <a href="https://github.com/greatscottgadgets/greatfet/tree/master/firmware/greatfet_usb/classes/debug.c"><code>greatfet.git:/firmware/greatfet_usb/classes/debug.c</code></a></h4>

<p>Debug utilities:</p>

<ul>
<li><code>verb_read_dmesg() -&gt; ?</code></li>
<li><code>verb_clear_dmesg()</code></li>
<li><code>verb_peek(address: u32) -&gt; u32</code></li>
<li><code>verb_poke(address: u32, value: u32)</code></li>
</ul>

<h4 id="0x11selftest-greatfet.git:firmwaregreatfet_usbclassesselftest.chttps:github.comgreatscottgadgetsgreatfettreemasterfirmwaregreatfet_usbclassesselftest.c"><code>0x11 selftest</code> - <a href="https://github.com/greatscottgadgets/greatfet/tree/master/firmware/greatfet_usb/classes/selftest.c"><code>greatfet.git:/firmware/greatfet_usb/classes/selftest.c</code></a></h4>

<p>Utilities for self-testing libgreat-based boards:</p>

<ul>
<li><code>selftest_verb_measure_clock_frequencies(clock_numbers: [u32]) -&gt; [clock_frequencies_mhz: u32]</code></li>
<li><code>selftest_verb_measure_raw_clock_frequencies(clock_numbers: [u32]) -&gt;  [clock_frequencies_mhz: u32]</code></li>
</ul>

<h4 id="0x105usbhost-"><code>0x105 usbhost</code> - <a href="">``</a></h4>

<p>Remote control over Luna's USB ports in host mode, for e.g. FaceDancer</p>

<p><em>(is this currently supported ? see <a href="">Open Questions</a>)</em></p>

<!--
*``
*``
*``
*``
-->

<h4 id="0x10aleds-greatfet.git:firmwaregreatfet_usbclassesleds.chttps:github.comgreatscottgadgetsgreatfettreemasterfirmwaregreatfet_usbclassesleds.c"><code>0x10A leds</code> - <a href="https://github.com/greatscottgadgets/greatfet/tree/master/firmware/greatfet_usb/classes/leds.c"><code>greatfet.git:/firmware/greatfet_usb/classes/leds.c</code></a></h4>

<p>Control over a given board’s LEDs:</p>

<ul>
<li><code>leds_verb_toggle(led_num)</code></li>
<li><code>leds_verb_on(led_num)</code></li>
<li><code>leds_verb_off(led_num)</code></li>
</ul>

<h4 id="0x120moondancer-greatfet.git:firmwaregreatfet_usbclassesgreatdancer.chttps:github.comgreatscottgadgetsgreatfettreemasterfirmwaregreatfet_usbclassesgreatdancer.c"><code>0x120 moondancer</code> - <a href="https://github.com/greatscottgadgets/greatfet/tree/master/firmware/greatfet_usb/classes/greatdancer.c"><code>greatfet.git:/firmware/greatfet_usb/classes/greatdancer.c</code></a></h4>

<p>Remote control over Luna's USB ports in device mode, for e.g. FaceDancer</p>

<p>Connection / disconnection:</p>

<ul>
<li><code>greatdancer_verb_connect(ep0_max_packet_size: u16, quirk_flags: u16</code></li>
<li><code>greatdancer_verb_disconnect()</code></li>
<li><code>greatdancer_verb_bus_reset()</code></li>
</ul>

<p>Enumeration / setup:</p>

<ul>
<li><code>greatdancer_verb_set_address(address: u16, deffered: u8)</code></li>
<li><code>greatdancer_verb_set_up_endpoints(endpoint_descriptors: [(address: u8, max_packet_size: u16, type: u8)])</code></li>
</ul>

<p>Status &amp; control:</p>

<ul>
<li><code>greatdancer_verb_get_status(register_type: u8) -&gt; register_value: [u8; 4]</code></li>
<li><code>greatdancer_verb_read_setup(endpoint_number: u8) -&gt; raw_setup_packet: [u8; 8]</code></li>
<li><code>greatdancer_verb_stall_endpoint(endpoint_address: u8)</code></li>
</ul>

<p>Data transfers:</p>

<ul>
<li><code>greatdancer_verb_send_on_endpoint(endpoint_number: u8, data_to_send: [u8])</code></li>
<li><code>greatdancer_verb_clean_up_transfer(endpoint_address: u8)</code></li>
<li><code>greatdancer_verb_start_nonblocking_read(endpoint_number: u8)</code></li>
<li><code>greatdancer_verb_finish_nonblocking_read(endpoint_number: u8) -&gt; read_data: [u8; length]</code></li>
<li><code>greatdancer_verb_get_nonblocking_data_length(endpoint_number: u8) -&gt; length: u32</code></li>
</ul>

<h4 id="0x10fusbproxy-"><code>0x10F usbproxy</code> - <a href="">``</a></h4>

<p>Firmware functionality supporting USBProxy</p>

<p><em>(is this supported ? see <a href="">Open Questions</a>)</em></p>

<!--
*``
*``
*``
*``
-->

<h3 id="3.7maintasks">3.7 Main Tasks</h3>

<h4 id="initialbring-up">Initial Bring-up</h4>

<ul>
<li>[ ] Implement <code>blinky</code> for LunaSoC.</li>
<li>[ ] Implement <code>uart</code> for LunaSoC.</li>
</ul>

<h4 id="lunasocfirmware">Luna SoC Firmware</h4>

<ul>
<li>[ ] Implement clock and reset control for the SoC.</li>
<li>[ ] Configure memory access for:

<ul>
<li>SoC SPI Flash peripheral</li>
<li>SoC SRAM</li>
<li>SoC HyperRAMInterface Peripheral</li>
</ul></li>
<li>[ ] Implement a <code>no_std</code> error handling strategy that does not rely on the <code>alloc</code> feature.</li>
<li>[ ] Implement a device logging strategy:

<ul>
<li>logs shall be recoverable following system panic.</li>
<li>logs shall be accessible at runtime via <code>0x10 debug</code>.</li>
</ul></li>
<li>[ ] Implement a task scheduling and interrupt handling strategy.</li>
<li>[ ] Implement a device hearbeat mechanism.</li>
<li>[ ] Implement a SoC firmware loading strategy.</li>
<li>[ ] Implement a SoC firmware update mechanism.</li>
</ul>

<h4 id="lunasocperipheraldrivers">Luna SoC Peripheral Drivers</h4>

<ul>
<li>[ ] Implement an <code>embedded-hal</code> driver for <code>luna.gateware.soc.GpioPeripheral</code></li>
<li>[ ] Implement an <code>embedded-hal</code> driver for <code>lambdasoc.periph.timer.TimerPeripheral</code></li>
<li>[ ] Implement an <code>embedded-hal</code> driver for <code>amaranth_stdio.serial.AsyncSerial</code></li>
<li>[ ] Implement an <code>embedded-hal</code> driver for <code>luna.gateware.usb2.USBDeviceController</code></li>
<li>[ ] Implement an <code>embedded-hal</code> driver for <code>luna.gateware.interface.flash.ECP5ConfigurationFlashInterface</code></li>
</ul>

<h4 id="commandserializationandtransportlibrary">Command Serialization and Transport Library</h4>

<ul>
<li>[ ] Implement a GCP transport for the USBDeviceController peripheral driver.</li>
<li>[ ] Implement support for the &quot;Great Communication Protocol&quot; serialization format using the <a href="https://serde.rs/data-format.html"><code>serde</code></a> crate.</li>
<li>[ ] Implement a dispatch mechanism for GCP commands and responses.</li>
</ul>

<h4 id="lunadeviceapi">Luna Device API</h4>

<ul>
<li>[ ] Implement the device api for: <code>0x0 core</code></li>
<li>[ ] Implement the device api for: <code>0x1 firmware</code></li>
<li>[ ] Implement the device api for: <code>0x10 debug</code></li>
<li>[ ] Implement the device api for: <code>0x11 selftest</code></li>
<li>[ ] Implement the device api for: <code>0x10A leds</code></li>
<li>[ ] Implement the device api for: <code>0x120 moondancer</code></li>
<li>[ ] Implement the device api for: <code>0x10F usbproxy</code></li>
</ul>

<hr />

<h2 id="4devicesidegatewareimplementation">4 Device Side Gateware Implementation</h2>

<figure>
<img src="structure/luna_git.gateware_soc.svg" alt="Diagram: Device SoC" />
<figcaption>Diagram: Device SoC</figcaption>
</figure>

<p>The execution target for the Luna firmware is a Minerva RISC-V CPU implemented as gateware on an ECP5 and shall be configured with a number of peripherals for control of the Luna hardware's USB ports, Pmod ports, SPI Flash and HyperRAM.</p>

<p>Additional SoC peripherals shall include a system Timer, UART and JTAG port.</p>

<p>SoC peripheral access interfaces will be generated directly from the SoC definition and shall include targets for:</p>

<ul>
<li>C</li>
<li>Rust</li>
</ul>

<p>Rust target support will be implemented by converting the SoC definition to a <a href="https://www.keil.com/pack/doc/CMSIS/SVD/html/svd_Format_pg.html">CMSIS-SVD</a> file that can be used to generate a Rust Peripheral Access Crate using the <a href="https://github.com/rust-embedded/svd2rust/"><code>svd2rust</code></a> tool.</p>

<p>Gateware shall be implemented in <a href="https://github.com/amaranth-lang/amaranth">Amaranth</a> with the use of external libraries such as <code>Amaranth-SoC</code> and <code>LambdaSoC</code> where possible.</p>

<h4 id="referenceimplementation">Reference Implementation</h4>

<p><a href="https://github.com/greatscottgadgets/luna/blob/main/luna/gateware/soc/simplesoc.py">luna.git:/gateware/soc/simplesoc.py</a></p>

<h3 id="4.2maintasks">4.2 Main Tasks</h3>

<h4 id="initialbring-up">Initial Bring-Up</h4>

<ul>
<li>[ ] Update the <code>simplesoc.py</code> placeholder to the latest versions of the <code>amaranth-soc</code> and <code>lambdasoc</code> libraries.</li>
<li>[ ] Implement SVD export for SoC designs

<ul>
<li>Bear in mind that this would benefit from finding a cosy home upstream.</li>
</ul></li>
</ul>

<h4 id="implementadditionalperipherals">Implement additional Peripherals</h4>

<ul>
<li>[ ] GpioPeripheral</li>
<li>[ ] SPIFlashPeripheral ?</li>
</ul>

<h4 id="wireupadditionalperipherals">Wire up additional Peripherals</h4>

<ul>
<li>[ ] GpioPeripheral</li>
<li>[ ] SPIFlashPeripheral / ECP5ConfigurationFlashInterface ?</li>
<li>[ ] USBDeviceController</li>
<li>[ ] HyperRAMInterface</li>
</ul>

<hr />

<h2 id="5lunahost-sidecli">5 Luna Host-side CLI</h2>

<p>Luna should have a host-side command line interface which enables Luna owners to interact with the device hardware.</p>

<p>The following conventions should be respected:</p>

<ul>
<li>Commands shall be implemented as a single keyword containing no preceding or interceding dash or underscore tokens to distinguish them from flags.</li>
<li>Flags shall be distinguished by a single dash (abbreviated flag name) and a double dash (expanded flag name).</li>
<li>Abbreviated flag names shall use the first letter of their expanded variant. Where this leads to conflicts alternative wording should be explored for the expanded names.</li>
<li>Abbreviated flag names shall be capitalized in order to further distinguish them from expanded flag names.</li>
<li>Abbreviated flag names may be omitted for lesser-used commands (e.g. <code>--keep-files</code>)</li>
</ul>

<h3 id="5.1description">5.1 Description</h3>

<h4 id="utilitycommandsshallinclude:">Utility Commands shall include:</h4>

<ul>
<li><code>info</code>: Displays information about connected Luna devices.</li>
<li><code>factory</code>: Restores the device to it's factory configuration state and applies any newly released firmware and gateware updates.</li>
<li><code>reset</code>: Performs a device reset.</li>
<li><code>shell</code>: Start up an interactive Python shell from which the Luna host-side Python Library can be called.</li>
</ul>

<h4 id="usercommandsshallinclude:">User Commands shall include:</h4>

<ul>
<li>TBD - basically any top-level (i.e. non-facedancer) Luna functionality we're currently calling from standalone scripts.</li>
</ul>

<h4 id="bitstreamcommandsshallinclude:">Bitstream Commands shall include:</h4>

<ul>
<li><code>output</code>: Build and output a bitstream to the given file.</li>
<li><code>erase</code>: Clears the relevant FPGA's flash before performing other options.</li>
<li><code>upload</code>: Uploads the relevant design to the target hardware. Default if no options are provided.</li>
<li><code>flash</code>: Flashes the relevant design to the target hardware's configuration flash.</li>
</ul>

<p>The following flags shall be supported:</p>

<ul>
<li><code>--dry-run, -D</code>: When provided as the only option; builds the relevant bitstream without uploading or flashing it.</li>
<li><code>--keep-files</code>: Keeps the local files in the default <code>build</code> folder.</li>
<li><code>--fpga</code>: Overrides build configuration to build for a given FPGA. Useful if no FPGA is connected during build.</li>
<li><code>--console</code>: Attempts to open a convenience 115200 8N1 UART console on the specified port immediately after uploading.</li>
</ul>

<h4 id="soccommandsshallinclude:">SoC Commands shall include:</h4>

<ul>
<li><code>upload</code>: Uploads the given SoC Firmware to the SoC.</li>
<li><code>flash</code>: Flashes the given SoC Firmware to the target hardware's configuration flash.</li>
<li><code>sdk</code>: Generates a developer SDK for programming the Luna SoC.</li>
</ul>

<p>The following flags shall be supported:</p>

<ul>
<li><code>--format=svd</code>:</li>
<li><code>--format=c-header</code>: A C header file for this design's SoC will be printed to the stdout. Other options ignored.</li>
<li><code>--format=ld-script</code>: A linker script for design's SoC memory regions be printed to the stdout. Other options ignored.</li>
<li><code>--format=rust-pac</code>: A Rust Peripheral Access Crate (PAC) for this design's SoC will be generated in the default <code>build/</code> directory.</li>
</ul>

<h4 id="globalflagsshallinclude:">Global flags shall include:</h4>

<ul>
<li><code>--help</code>: Display Luna CLI help.</li>
<li><code>--build-dir</code>: Override the default <code>build/</code> directory.</li>
<li><code>--</code> All flags following a naked double-dash will be passed to any tools invoked by the Luna CLI.</li>
<li>TBD</li>
</ul>

<h4 id="namingconsiderations">Naming considerations</h4>

<ul>
<li>Consider: <code>output</code> -&gt; <code>bitstream</code></li>
<li>Resolve identical commands in separate contexts (e.g. <code>flash</code>)

<ul>
<li>Option: Use a class/verb structure for commands e.g. <code>luna bitstream flash</code> / <code>luna firmware flash</code></li>
<li>Option: Use different command names e.g. <code>store</code> for bitstream, <code>flash</code> for firmware.</li>
</ul></li>
</ul>

<h4 id="referenceimplementation:">Reference Implementation:</h4>

<ul>
<li><a href="https://github.com/greatscottgadgets/luna/blob/main/luna/__init__.py"><code>luna.git:/luna/__init__.py</code></a></li>
<li><a href="https://github.com/greatscottgadgets/greatfet/blob/master/host/greatfet/utils.py#L137"><code>GreatFETArgumentParser</code></a></li>
</ul>

<p>It's recommended that the design of <code>GreatFETArgumentParser</code> be adapted for general use, renamed to <code>GreatArgumentParser</code> and homed in <code>libgreat.git</code>.</p>

<h3 id="5.2maintasks">5.2 Main Tasks</h3>

<ul>
<li>[ ] ...</li>
</ul>

<hr />

<h2 id="6additionalfeatures">6 Additional Features</h2>

<h3 id="6.1additionalfacedancerapplets">6.1 Additional Facedancer Applets</h3>

<p>Facedancer device emulations are referred to as &quot;Applets&quot; (is this correct?) that can be found in the <a href="https://github.com/greatscottgadgets/Facedancer/tree/master/facedancer/devices">facedancer.git:/facedancer/devices</a> directly.</p>

<p>There are currently Facedancer Applets for:</p>

<ul>
<li><a href="https://github.com/greatscottgadgets/Facedancer/blob/master/facedancer/devices/ftdi.py"><code>FTDIDevice</code></a> - Emulated FTDI USB Serial device.</li>
<li><a href="https://github.com/greatscottgadgets/Facedancer/blob/master/facedancer/devices/keyboard.py"><code>USBKeyboardDevice</code></a> - Simple USB Keyboard device.</li>
</ul>

<p>There are also a number of Facedancer Applets that live in the <a href="https://github.com/greatscottgadgets/Facedancer/tree/master/legacy-applets">facedancer.git:/legacy_applets/</a> directory. If is due to API changes they should probably be refactored to the new API so that they be made available:</p>

<ul>
<li><code>facedancer-edl</code></li>
<li><code>facedancer-ftdi</code></li>
<li><code>facedancer-host-enumeration</code></li>
<li><code>facedancer-keyboard-interactive</code></li>
<li><code>facedancer-keyboard</code></li>
<li><code>facedancer-procontroller</code></li>
<li><code>facedancer-serial</code></li>
<li><code>facedancer-switchtas</code></li>
<li><code>facedancer-umass</code></li>
<li><code>facedancer-ums-doublefetch</code></li>
</ul>

<h3 id="6.2supportforlunapmodports">6.2 Support for Luna Pmod Ports</h3>

<p>There exists an opportunity to make the GreatFET gpio-related commands available under Luna as well.</p>

<h3 id="6.3newfacedancerappletcreation">6.3 New Facedancer Applet Creation</h3>

<p>Enabling new Facedancer Applet creation primarily requires that the Facedancer Applet API be documented.</p>

<h3 id="6.4usbproxy">6.4 USBProxy</h3>

<p>TBD</p>

<h3 id="6.5usbfuzzing">6.5 USB Fuzzing</h3>

<p>TBD</p>

<h3 id="6.6maintasks">6.6 Main Tasks</h3>

<ul>
<li>[ ] Bring Facedancer's legacy Applets up to date</li>
<li>[ ] Support GreatFET gpio-related commands</li>
<li>[ ] Document the Facedancer Applet API</li>
<li>[ ] Specify USBProxy Support</li>
<li>[ ] Implement USBProxy Support</li>
<li>[ ] Specify USB Fuzzing Support</li>
<li>[ ] Implement USB Fuzzing Support</li>
</ul>

<hr />

<h2 id="7continuousintegration">7 Continuous Integration</h2>

<h3 id="7.1integrationtests">7.1 Integration Tests</h3>

<p>TBD</p>

<h3 id="7.2host-sidetests">7.2 Host-side Tests</h3>

<p>TBD</p>

<h3 id="7.3device-sidetests">7.3 Device-side Tests</h3>

<p>TBD</p>

<h3 id="7.4maintasks">7.4 Main Tasks</h3>

<ul>
<li>[ ] ...</li>
</ul>

<hr />

<h2 id="8documentation">8 Documentation</h2>

<p>Primary documentation should be developed for:</p>

<ul>
<li>Getting started with Luna and Facedancer</li>
<li>Facedancer Applet reference</li>
<li>Luna host-side API reference</li>
<li>Luna device-side API reference (docs.rs)</li>
</ul>

<p>Additional documentation:</p>

<ul>
<li>Luna Tutorials</li>
<li>Facedancer Applet API reference</li>
</ul>

<h3 id="8.1maintasks">8.1 Main Tasks</h3>

<ul>
<li>[ ] ...</li>
</ul>

<h3 id="8.2references">8.2 References</h3>

<ul>
<li><a href="https://greatscottgadgets.github.io/greatfet-tutorials/">GreatFET Tutorials</a></li>
<li><a href="https://greatfet.readthedocs.io/en/latest/">GreatFET Project documentation</a></li>
<li><a href="https://github.com/greatscottgadgets/Facedancer/blob/master/README.md">Facedancer README</a></li>
</ul>

<p>External:</p>

<ul>
<li><a href="https://wikileaks.org/ciav7p1/cms/page_20873567.html">WikiLeaks - Facedancer User Guide</a></li>
<li><a href="https://travisgoodspeed.blogspot.com/2012/07/emulating-usb-devices-with-python.html">Travis Goodspeed - Emulating USB Devices with Python</a></li>
<li><a href="https://hackaday.com/2019/07/02/hands-on-greatfet-is-an-embedded-tool-that-does-it-all/">Hackaday - Hands-on: GreatFET</a></li>
<li><a href="https://circuitcellar.com/research-design-hub/usb-attacks-and-more-with-greatfet/">Colin O'Flunn - USB Attacks and More with GreatFET</a></li>
</ul>

<hr />

<h2 id="9codeorganization">9 Code Organization</h2>

<p>The <code>luna.git</code> repository should utilize GSG repository layout conventions with the following top-level structure:</p>

<pre><code>/ci-scripts  - Scripts used by CI
/docs        - Documentation
/firmware    - Device firmware
/hardware    - Device hardware (deprecated: see note below)
/gateware    - Device gateware
/host        - Host-side software
/tools       - Tools
</code></pre>

<blockquote>
<p>Note: The hardware release cycle operates on a different time-scale to software release cycles. Ideally device hardware should live in its own repository.</p>
</blockquote>

<p>To reduce the maintenance burden across the larger Great Scott Gadgets codebase it's proposed to make some minor changes to the organization of the greatfet.git and libgreat.git repositories.</p>

<h3 id="9.1facedancergreatcommunicationprotocolclassid:">9.1 Facedancer &quot;Great Communication Protocol&quot; class id:</h3>

<p>Class ids currently live in:</p>

<p>https://github.com/greatscottgadgets/greatfet/blob/master/docs/source/greatfet_classes.rst</p>

<ol>
<li>Move greatfet_classes.rst from greatfet.git into libgreat.git</li>
<li>Add class id for Luna</li>
</ol>

<p>Also see: https://gsg.atlassian.net/wiki/spaces/MEETINGS/pages/2438824143/2022-12-06+Engineering+Work+Session</p>

<h3 id="9.2commoncodefromgreatfet.git">9.2 Common code from greatfet.git</h3>

<p>There may be some common code in the greatfet.git python host code that needs to be made available to Luna. This may also need to move to the libreat.git repository.</p>

<p>This includes:</p>

<ul>
<li>https://github.com/greatscottgadgets/greatfet/blob/master/host/greatfet/commands/greatfet_usb_capture.py</li>
<li>TODO</li>
</ul>

<h3 id="9.3conformancetogsgprojectdirectorylayoutconventions">9.3 Conformance to GSG project directory layout conventions</h3>

<p>For the <code>luna.git</code> repository the following changes should be made:</p>

<ul>
<li><code>luna.git:/luna/gateware</code> -&gt; <code>luna.git:/gateware</code></li>
<li><code>luna.git:/luna/</code> -&gt; <code>luna.git:/host/luna</code></li>
</ul>

<h3 id="9.4gitsubmodulesakakillitwithfire">9.4 Git submodules aka &quot;Kill It With Fire!&quot;</h3>

<p>A strategy of escalation for dependencies that exist as git submodules:</p>

<ol>
<li>Prefer the packaged library form.</li>
<li>If a packaged library does not exist fork the project and submit an upstream PR.</li>
<li>Switch to the packaged library from our fork while waiting for the PR process to play out.</li>
<li>If upstream can/will not accept the PR consider moving to an alternate dependency more aligned with our use-case.</li>
<li>If another dependency does not exist there are two choices:

<ul>
<li>Maintain our fork indefinitely. Sometimes this is not a big deal and upstream positions often shift given time, congeniality and reflection.</li>
<li>Vendor the forked code into <code>libgreat.git</code> remembering to include licenses and a great-full acknowledgement.</li>
</ul></li>
</ol>

<p>This strategy is hard work that can cost a couple days work but we pay it forward because, in Glorious Socialist Federation of Neighbours, upstream project take care of you!</p>

<hr />

<h2 id="10openquestions">10 Open Questions</h2>

<ul>
<li><p>[ ] are the Great Communication Protocol <code>0x105 usbhost</code> and <code>0x10F subproxy</code> classes supported anywhere currently?</p>

<ul>
<li>if so, where are the implementations hiding?</li>
</ul></li>
<li><p>[ ] how do we want to manage SoC firmware uploads to SPI flash</p>

<ul>
<li>appended to the bitstream uploaded to SPI flash?</li>
<li>SoC bios takes over SPI flash after ECP5 boot and uses a dedicated region for separate upload?</li>
<li>Which of the many available tools should Luna CLI use if we support a separate flash operations?</li>
<li>other ?</li>
</ul></li>
<li><p>[ ] do we want to support these additional usb-related classes for Luna:</p>

<ul>
<li><code>0x107 glitchkit_usb</code> - control over functionality intended to help with timing USB fault injection</li>
<li><code>0x113 usb_analysis</code> - functionality for USB analysis e.g. with Rhododendron</li>
</ul></li>
<li><p>[ ] are there any constraints on the &quot;Great Communications Protocol&quot; implementation that will place limits on what we can do with Luna vs GreatFET?</p></li>
<li><p>[ ] <code>libgreat-rs.git</code> -&gt; <code>libgreat.git/firmware-rs/greatsoc-hal, greatsoc-pac</code> etc. or somesuch ?</p>

<ul>
<li>the problem with having two repo's that both start with libgreat is that it may not be clear which one to look in?</li>
<li>on the other hand, nervous about putting the rust crate into libgreat because more complex CI and releases might ensue ?</li>
</ul></li>
<li><p>[ ] Should we implement the main device firmware in a pure Rust <code>no_std</code> environment without the use of the <code>alloc</code> feature?</p>

<ul>
<li><code>alloc</code> comes with its own share of problems in the form of memory fragmentation and unpredictable latency.</li>
<li>are there any high-alloc areas of the code that can't be handled by e.g. the <code>heapless</code> crate.</li>
</ul></li>
</ul>

<hr />

<h2 id="11diagrams">11 Diagrams</h2>

<h3 id="dataflowcomparisonofgreatfetandluna">Dataflow Comparison of GreatFET and Luna</h3>

<figure>
<img src="dataflow/top_dataflow.svg" alt="Diagram: Dataflow Comparison of GreatFET and Luna" />
<figcaption>Diagram: Dataflow Comparison of GreatFET and Luna</figcaption>
</figure>

<h3 id="device-sidestructuraldecomposition">Device-side Structural Decomposition</h3>

<figure>
<img src="structure/top_structure.svg" alt="Diagram: Device-side Structural Decomposition" />
<figcaption>Diagram: Device-side Structural Decomposition</figcaption>
</figure>

<h3 id="facedancercallgraph">Facedancer Call Graph</h3>

<figure>
<img src="facedancer/top_facedancer.svg" alt="Diagram: Facedancer Call Graph" />
<figcaption>Diagram: Facedancer Call Graph</figcaption>
</figure>

<hr />

<h2 id="12appendix">12 Appendix</h2>

<h3 id="linkstousefuldocumentation">Links to Useful Documentation</h3>

<ul>
<li><a href="https://greatfet.readthedocs.io/en/latest/">GreatFET Documentation</a>

<ul>
<li><a href="https://greatfet.readthedocs.io/en/latest/libgreat_verb_signatures.html">Verb Signatures</a></li>
<li><a href="https://greatfet.readthedocs.io/en/latest/greatfet_classes.html">Classes</a></li>
</ul></li>
</ul>

<p>External:</p>

<ul>
<li><a href="https://wikileaks.org/ciav7p1/cms/page_20873567.html">WikiLeaks - Facedancer User Guide</a></li>
<li><a href="https://serde.rs/data-format.html">Writing a Serde data format</a></li>
<li><a href="https://www.beyondlogic.org/usbnutshell/">Beyond Logic - USB in a NutShell</a></li>
</ul>

<h3 id="repositories">Repositories</h3>

<ul>
<li>https://github.com/antoinevg/GSG-private/</li>
<li>https://github.com/antoinevg/luna</li>
<li>https://github.com/antoinevg/Facedancer</li>
<li>https://github.com/greatscottgadgets/libgreat</li>
<li>https://github.com/greatscottgadgets/greatfet</li>
</ul>

<h3 id="issues">Issues</h3>

<ul>
<li><a href="https://github.com/greatscottgadgets/luna/issues/68">FaceDancer: Implement Initial Design Specification / RFP #68</a></li>
<li><a href="https://github.com/greatscottgadgets/luna/issues/151">Facedancer SoC #151</a></li>
<li><a href="https://github.com/greatscottgadgets/Facedancer/issues/59">LUNA support for Facedancer #59</a></li>
</ul>

</body>
</html>

